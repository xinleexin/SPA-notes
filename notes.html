<!DOCTYPE html>
<html>
<head>
    <title>Markdown Notebook</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh;
            display: flex;
            flex-direction: row;
        }
        .panel {
            height: 100vh;
            overflow-y: auto;
            padding: 10px;
        }
        .notes-panel {
            width: 20%;
            border-right: 1px solid #ccc;
            flex-shrink: 0;
        }
        .edit-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .history-panel {
            width: 20%;
            border-left: 1px solid #ccc;
            flex-shrink: 0;
        }
        .resize-handle {
            width: 5px;
            background-color: #ccc;
            cursor: col-resize;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            flex-shrink: 0;
        }
        .resize-handle:hover {
            background-color: #999;
        }
        .create-note-btn {
            padding: 8px 16px;
            margin: 10px 0;
            border-radius: 4px;
            border: none;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }
        .create-note-btn:hover {
            background-color: #218838;
        }
        .note-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
        }
        .note-item:hover {
            background-color: #e0e0e0;
        }
        .note-item.selected {
            background-color: #007bff;
            color: white;
        }
        .edit-content {
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-family: monospace;
        }
        .edit-toolbar {
            padding: 10px;
            border-top: 1px solid #ccc;
            display: flex;
            gap: 10px;
        }
        .edit-btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .edit-btn:hover {
            background-color: #0056b3;
        }
        .history-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e0e0e0;
        }
        .history-item.selected {
            background-color: #007bff;
            color: white;
        }
        .markdown-view {
            padding: 10px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item:hover {
            background-color: #f0f0f0;
        }
        .inline-rename-input {
            width: calc(100% - 40px);
            height: 100%;
            border: none;
            padding: 0 5px;
            box-sizing: border-box;
        }
        .inline-rename-btn {
            height: 100%;
            width: 30px;
            border: none;
            background: #28a745;
            color: white;
            cursor: pointer;
            margin-left: 5px;
        }
        .inline-rename-btn:hover {
            background: #218838;
        }
        .markdown-content {
            margin: 0;
            padding: 0;
        }
        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .markdown-content h3 {
            font-size: 1.2em;
        }
        .markdown-content p {
            line-height: 1.6;
        }
        .markdown-content code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .markdown-content pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 20px;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 10px;
            margin-left: 0;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Include marked.js for better markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <div class="panel notes-panel" id="notesPanel">
        <button class="create-note-btn" id="createNoteBtn">Create Note</button>
        <div id="notesList"></div>
        <div style="margin-top: 10px; padding: 10px; border-top: 1px solid #ccc;">
            <button class="create-note-btn" id="importNotesBtn" style="background-color: #17a2b8;">Import Notes</button>
            <button class="create-note-btn" id="exportNotesBtn" style="background-color: #28a745;">Export Notes</button>
        </div>
    </div>
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="panel edit-panel" id="editPanel">
        <textarea class="edit-content" id="editContent" placeholder="Enter your markdown content here..."></textarea>
        <div class="edit-toolbar">
            <button class="edit-btn" id="toggleViewBtn">Show</button>
            <button class="edit-btn" id="saveBtn" title="Save as a new version">Save</button>
        </div>
    </div>
    <div class="panel history-panel" id="historyPanel">
        <h3>History</h3>
        <div id="historyList"></div>
        <div id="contextMenu" class="context-menu"></div>
    </div>

    <script>
        // Global variables
        let notes = {};
        let currentNoteId = null;
        let currentView = 'source'; // 'source' or 'preview'
        let autoSaveTimer = null;
        let lastSavedContent = '';
        let importedFromFile = false; // Track if notes were imported from a file
        let importedFilePath = ''; // Track the path of the imported file
        let debugMode = true; // Enable/disable console logs

        // DOM Elements
        const notesPanel = document.getElementById('notesPanel');
        const notesList = document.getElementById('notesList');
        const createNoteBtn = document.getElementById('createNoteBtn');
        const importNotesBtn = document.getElementById('importNotesBtn');
        const exportNotesBtn = document.getElementById('exportNotesBtn');
        const editPanel = document.getElementById('editPanel');
        const editContent = document.getElementById('editContent');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const saveBtn = document.getElementById('saveBtn');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const contextMenu = document.getElementById('contextMenu');

        // Initialize the application
        function init() {
            if (debugMode) console.log('Initializing application');
            loadNotes();
            updateNotesList();
            setupEventListeners();
            if (debugMode) console.log('Application initialized');
        }

        // Load notes from localStorage
        function loadNotes() {
            if (debugMode) console.log('Loading notes from localStorage');
            const savedNotes = localStorage.getItem('markdownNotes');
            if (savedNotes) {
                if (debugMode) console.log('Found saved notes');
                notes = JSON.parse(savedNotes);
            } else {
                if (debugMode) console.log('No saved notes, creating default');
                // Initialize with a default note if none exists
                const defaultNoteId = Date.now().toString();
                notes = {
                    [defaultNoteId]: {
                        title: 'Default Note',
                        content: '# Welcome to Markdown Notebook\n\nStart writing your notes here...',
                        history: []
                    }
                };
                saveNotes();
            }
            if (debugMode) console.log('Notes loaded:', notes);
            
            // Automatically select the first note if notes exist
            if (Object.keys(notes).length > 0 && !currentNoteId) {
                const firstNoteId = Object.keys(notes)[0];
                selectNote(firstNoteId);
            }
        }

        // Save notes to localStorage
        function saveNotes() {
            localStorage.setItem('markdownNotes', JSON.stringify(notes));
        }

        // Setup event listeners
        function setupEventListeners() {
            if (debugMode) console.log('Setting up event listeners');
            if (createNoteBtn) {
                createNoteBtn.addEventListener('click', function() {
                    if (debugMode) console.log('Create note button clicked - inside event listener');
                    notesAdd();
                });
                if (debugMode) console.log('Create note button event listener set');
            } else {
                if (debugMode) console.log('ERROR: createNoteBtn not found');
            }
            
            if (importNotesBtn) {
                importNotesBtn.addEventListener('click', importNotes);
                if (debugMode) console.log('Import notes button event listener set');
            } else {
                if (debugMode) console.log('ERROR: importNotesBtn not found');
            }
            
            if (exportNotesBtn) {
                exportNotesBtn.addEventListener('click', exportNotes);
                if (debugMode) console.log('Export notes button event listener set');
            } else {
                if (debugMode) console.log('ERROR: exportNotesBtn not found');
            }
            
            if (editContent) {
                editContent.addEventListener('input', handleEditInput);
                if (debugMode) console.log('Edit content input listener set');
            }
            
            if (toggleViewBtn) {
                toggleViewBtn.addEventListener('click', editToggleView);
                if (debugMode) console.log('Toggle view button listener set');
            }
            
            if (saveBtn) {
                saveBtn.addEventListener('click', editSave);
                if (debugMode) console.log('Save button listener set');
            }
            
            // Setup resize handle event listeners
            const resizeHandle = document.getElementById('resizeHandle');
            if (resizeHandle) {
                let isResizing = false;
                let startX;
                let startWidth;
                
                resizeHandle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = notesPanel.offsetWidth;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isResizing) return;
                    
                    const newWidth = startWidth + (e.clientX - startX);
                    // Ensure minimum width
                    if (newWidth > 100 && newWidth < window.innerWidth * 0.8) {
                        notesPanel.style.width = newWidth + 'px';
                        // Adjust edit panel width to fill remaining space
                        editPanel.style.width = (window.innerWidth - newWidth - resizeHandle.offsetWidth) + 'px';
                    }
                });
                
                document.addEventListener('mouseup', function() {
                    isResizing = false;
                });
                
                if (debugMode) console.log('Resize handle event listeners set');
            } else {
                if (debugMode) console.log('ERROR: resizeHandle not found');
            }
            
            // Hide context menu when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (e.target !== contextMenu && !contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });
            if (debugMode) console.log('Global click listener set');
        }

        // Import notes from a JSON file
        function importNotes() {
            if (debugMode) console.log('Importing notes');
            
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) {
                    if (debugMode) console.log('No file selected');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const fileContent = e.target.result;
                        const importedNotes = JSON.parse(fileContent);
                        
                        // Validate the imported data structure
                        if (!validateImportedNotes(importedNotes)) {
                            alert('Invalid file format. Please select a valid notes file.');
                            if (debugMode) console.log('Invalid file format');
                            return;
                        }
                        
                        // Replace current notes with imported notes
                        notes = importedNotes;
                        saveNotes();
                        updateNotesList();
                        
                        // Track that notes were imported from a file
                        importedFromFile = true;
                        // For browser security reasons, we can only get the file name, not the full path
                        importedFilePath = file.name;
                        
                        if (debugMode) console.log('Notes imported successfully');
                    } catch (error) {
                        console.error('Error importing notes:', error);
                        alert('Error importing notes: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('Error reading file');
                    alert('Error reading file');
                };
                
                reader.readAsText(file);
            };
            
            // Trigger file selection
            fileInput.click();
        }

        // Export notes to a JSON file
        function exportNotes() {
            if (debugMode) console.log('Exporting notes');
            
            // If notes were imported from a file, export back to that same file
            if (importedFromFile && importedFilePath) {
                // Try to use File System Access API if available
                    if ('showSaveFilePicker' in self) {
                        // Use File System Access API
                        saveFileWithFileSystemAccessAPI(notes, importedFilePath);
                    } else {
                        // Fallback to traditional download approach
                        const dataStr = JSON.stringify(notes, null, 2);
                        saveDataToFile(dataStr, importedFilePath, 'application/json');
                    }
                    if (debugMode) console.log('Notes exported successfully to original file');
            } else {
                // Create a default filename with timestamp
                const fileName = 'notes-export-' + new Date().toISOString().slice(0, 10) + '.json';
                
                // Try to use File System Access API if available
                    if ('showSaveFilePicker' in self) {
                        // Use File System Access API
                        saveFileWithFileSystemAccessAPI(notes, fileName);
                    } else {
                        // Fallback to traditional download approach
                        const dataStr = JSON.stringify(notes, null, 2);
                        saveDataToFile(dataStr, fileName, 'application/json');
                    }
                    if (debugMode) console.log('Notes exported successfully');
            }
        }

        // Helper function to save data using File System Access API
        async function saveFileWithFileSystemAccessAPI(data, fileName) {
            try {
                // Create a Blob from the data
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                
                // Create a file handle using the File System Access API
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'JSON files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                
                // Write the file
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                if (debugMode) console.log('File saved successfully using File System Access API');
            } catch (error) {
                console.error('Error saving file with File System Access API:', error);
                // Fallback to traditional download approach
                const dataStr = JSON.stringify(data, null, 2);
                saveDataToFile(dataStr, fileName, 'application/json');
            }
        }

        // Helper function to save data to a file
        function saveDataToFile(data, filename, type) {
            // 1. Create a Blob object from the data
            const blob = new Blob([data], { type: type });

            // 2. Create a URL for the Blob object
            const url = URL.createObjectURL(blob);

            // 3. Create a temporary anchor element
            const a = document.createElement('a');
            a.href = url;
            a.download = filename; // Suggests a filename to the browser

            // 4. Append anchor to body, click it, and remove it
            // Appending to the body helps ensure the click event works in all browsers
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // 5. Revoke the object URL to free up memory
            URL.revokeObjectURL(url);
        }

        // Validate imported notes structure
        function validateImportedNotes(importedNotes) {
            if (!importedNotes || typeof importedNotes !== 'object') {
                return false;
            }
            
            // Check that each note has the required properties
            for (const [key, note] of Object.entries(importedNotes)) {
                if (typeof note !== 'object' || note === null) {
                    return false;
                }
                if (typeof note.title !== 'string' || typeof note.content !== 'string') {
                    return false;
                }
                if (!Array.isArray(note.history)) {
                    return false;
                }
            }
            
            return true;
        }

        // Handle input in edit panel for auto-save
        function handleEditInput() {
            // Clear existing timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // Set new timer (300ms delay)
            autoSaveTimer = setTimeout(() => {
                // Only save to localStorage but don't create new history version
                if (currentNoteId && notes[currentNoteId]) {
                    const content = editContent.value;
                    if (content !== lastSavedContent) {
                        notes[currentNoteId].content = content;
                        lastSavedContent = content;
                        saveNotes();
                    }
                }
            }, 300);
        }

        // Notes panel functions
        function notesAdd() {
            if (debugMode) console.log('notesAdd function called');
            // Create new note with datetime title
            const now = new Date();
            const dateTimeString = now.toLocaleString();
            const noteId = Date.now().toString();
            notes[noteId] = {
                title: `Note ${dateTimeString}`,
                content: '',
                history: []
            };
            if (debugMode) console.log('Created note with ID:', noteId);
            saveNotes();
            updateNotesList();
            selectNote(noteId);
            if (debugMode) console.log('Note creation completed');
        }

        function notesDelete(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                delete notes[noteId];
                saveNotes();
                updateNotesList();
                
                // If we deleted the current note, select the first one or clear the editor
                if (currentNoteId === noteId) {
                    if (Object.keys(notes).length > 0) {
                        const firstNoteId = Object.keys(notes)[0];
                        selectNote(firstNoteId);
                    } else {
                        editContent.value = '';
                        currentNoteId = null;
                    }
                }
            }
        }

        function notesRename(noteId) {
            const newTitle = prompt('Enter new title for the note:', notes[noteId].title);
            if (newTitle !== null && newTitle.trim() !== '') {
                notes[noteId].title = newTitle;
                saveNotes();
                updateNotesList();
            }
        }

        function selectNote(noteId) {
            if (notes[noteId]) {
                currentNoteId = noteId;
                editLoad(noteId);
                updateNotesList();
                historyList.innerHTML = '';
                updateHistoryList();
            }
        }

        function updateNotesList() {
            notesList.innerHTML = '';
            
            // Show empty state if no notes
            if (Object.keys(notes).length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = 'No notes yet. Create your first note!';
                notesList.appendChild(emptyState);
                return;
            }
            
            for (const [noteId, note] of Object.entries(notes)) {
                const div = document.createElement('div');
                div.className = 'note-item';
                if (currentNoteId === noteId) {
                    div.classList.add('selected');
                }
                div.textContent = note.title || 'Untitled Note';
                div.addEventListener('click', () => {
                    selectNote(noteId);
                });
                // Add right-click event listener for context menu
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showNoteContextMenu(e, noteId);
                });
                notesList.appendChild(div);
            }
        }

        function showNoteContextMenu(event, noteId) {
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // Clear existing menu items
            contextMenu.innerHTML = '';
            
            // Rename option
            const renameItem = document.createElement('div');
            renameItem.className = 'context-menu-item';
            renameItem.textContent = 'Rename';
            renameItem.addEventListener('click', () => {
                notesRename(noteId);
                contextMenu.style.display = 'none';
            });
            contextMenu.appendChild(renameItem);
            
            // Delete option
            const deleteItem = document.createElement('div');
            deleteItem.className = 'context-menu-item';
            deleteItem.textContent = 'Delete';
            deleteItem.addEventListener('click', () => {
                notesDelete(noteId);
                contextMenu.style.display = 'none';
            });
            contextMenu.appendChild(deleteItem);
        }

        // Edit panel functions
        function editLoad(noteId) {
            if (notes[noteId]) {
                editContent.value = notes[noteId].content;
                lastSavedContent = notes[noteId].content;
                updateForPreviewMode();
            }
        }

        function editToggleView() {
            if (currentView === 'source') {
                currentView = 'preview';
            } else {
                currentView = 'source';
            }
            updateForPreviewMode();
        }

        function updateForPreviewMode() {
            // if the currentView is preview, render the markdown preview in UX
            if (currentView === 'preview') {
                // Show preview - using marked.js for comprehensive markdown rendering
                const markdownContent = marked.parse(editContent.value);
                
                // Reuse existing preview div or create new one
                let previewDiv = document.getElementById('markdownPreview');
                if (!previewDiv) {
                    previewDiv = document.createElement('div');
                    previewDiv.className = 'markdown-view';
                    previewDiv.id = 'markdownPreview';
                    editPanel.appendChild(previewDiv);
                }
                previewDiv.innerHTML = markdownContent;
                editContent.style.display = 'none';
                toggleViewBtn.textContent = 'Source';
                
                // Hide save button when preview is shown
                saveBtn.style.display = 'none';
            } else {
                // Show source
                const previewDiv = document.getElementById('markdownPreview');
                if (previewDiv) {
                    previewDiv.remove();
                }
                editContent.style.display = 'block';
                toggleViewBtn.textContent = 'Show';
                
                // Show save button when source is shown
                saveBtn.style.display = 'block';
            }
        }

        function editSave() {
            if (currentNoteId && notes[currentNoteId]) {
                const content = editContent.value;
                // always save content regardless of if content is auto save or not
                notes[currentNoteId].content = content;
                    lastSavedContent = content;
                    saveNotes();
                    
                    // Create new version in history only when save button is clicked
                    historyCreate(currentNoteId);
                    
                    // Update history panel
                    updateHistoryList();
            }
        }

        // History panel functions
        function historyCreate(noteId) {
            if (notes[noteId]) {
                const now = new Date();
                // Create a unique timestamp to avoid duplicates
                let timestamp = now.toLocaleString();
                
                // Check if this timestamp already exists and make it unique
                let counter = 1;
                const originalTimestamp = timestamp;
                while (notes[noteId].history.some(v => v.timestamp === timestamp)) {
                    timestamp = `${originalTimestamp} (${counter})`;
                    counter++;
                }
                
                const version = {
                    timestamp: timestamp,
                    content: notes[noteId].content
                };
                notes[noteId].history.unshift(version);
                // Keep only last 20 versions
                if (notes[noteId].history.length > 20) {
                    notes[noteId].history = notes[noteId].history.slice(0, 20);
                }
                saveNotes();
            }
        }

        function historyDelete(noteId, versionId) {
            if (notes[noteId] && notes[noteId].history[versionId]) {
                // Remove the specific version
                notes[noteId].history.splice(versionId, 1);
                saveNotes();
                updateHistoryList();
            }
        }

        function historyRename(noteId, versionId, newName) {
            if (notes[noteId] && notes[noteId].history[versionId]) {
                notes[noteId].history[versionId].timestamp = newName;
                saveNotes();
                updateHistoryList();
            }
        }

        function updateHistoryList() {
            historyList.innerHTML = '';
            
            if (currentNoteId && notes[currentNoteId]) {
                const note = notes[currentNoteId];
                
                // Add current version
                const currentDiv = document.createElement('div');
                currentDiv.className = 'history-item selected';
                currentDiv.textContent = 'Current Version (auto saving)';
                currentDiv.addEventListener('click', () => {
                    historyVersionSelect(currentNoteId, 'current');
                });
                // Do NOT add right-click event listener for context menu on current version
                historyList.appendChild(currentDiv);
                
                // Add version history
                note.history.forEach((version, index) => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = version.timestamp;
                    div.addEventListener('click', () => {
                        historyVersionSelect(currentNoteId, index);
                    });
                    // Add right-click event listener for context menu
                    div.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showHistoryContextMenu(e, currentNoteId, index);
                    });
                    historyList.appendChild(div);
                });
            }
        }

        function historyVersionSelect(noteId, versionIndex) {
            // Clear previous selections
            const historyItems = historyList.querySelectorAll('.history-item');
            historyItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select the clicked item
            if (versionIndex === 'current') {
                // Select the current version item (which is the first item)
                const currentDiv = historyList.firstChild;
                if (currentDiv && currentDiv.classList.contains('history-item')) {
                    currentDiv.classList.add('selected');
                }
                editContent.value = notes[noteId].content;
                lastSavedContent = notes[noteId].content;
            } else {
                // Select the specific version item
                const versionDiv = historyList.children[versionIndex + 1]; // +1 because of current version
                if (versionDiv && versionDiv.classList.contains('history-item')) {
                    versionDiv.classList.add('selected');
                }
                editContent.value = notes[noteId].history[versionIndex].content;
                lastSavedContent = notes[noteId].history[versionIndex].content;
            }

            updateForPreviewMode();
        }

        function showHistoryContextMenu(event, noteId, versionId) {
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // Clear existing menu items
            contextMenu.innerHTML = '';
            
            // Rename option
            const renameItem = document.createElement('div');
            renameItem.className = 'context-menu-item';
            renameItem.textContent = 'Rename';
            renameItem.addEventListener('click', () => {
                // Hide the context menu
                contextMenu.style.display = 'none';
                
                // Find the history item element
                const historyItems = historyList.querySelectorAll('.history-item');
                let itemElement;
                if (versionId === 'current') {
                    itemElement = historyItems[0]; // First item is current version
                } else {
                    itemElement = historyItems[versionId + 1]; // +1 because of current version
                }
                
                if (itemElement) {
                    // Create inline rename UI
                    const originalText = itemElement.textContent;
                    itemElement.innerHTML = '';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = originalText;
                    input.className = 'inline-rename-input';
                    input.style.width = '75%';
                    input.style.height = '100%';
                    input.style.border = 'none';
                    input.style.padding = '0 5px';
                    input.style.boxSizing = 'border-box';
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.textContent = 'Save';
                    saveBtn.className = 'inline-rename-btn';
                    saveBtn.style.height = '100%';
                    saveBtn.style.width = '12%';
                    saveBtn.style.border = 'none';
                    saveBtn.style.background = '#28a745';
                    saveBtn.style.color = 'white';
                    saveBtn.style.cursor = 'pointer';
                    saveBtn.style.marginLeft = '1%';
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'X';
                    cancelBtn.className = 'inline-rename-btn';
                    cancelBtn.style.height = '100%';
                    cancelBtn.style.width = '12%';
                    cancelBtn.style.border = 'none';
                    cancelBtn.style.background = '#dc3545';
                    cancelBtn.style.color = 'white';
                    cancelBtn.style.cursor = 'pointer';
                    cancelBtn.style.marginLeft = '1%';
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.alignItems = 'center';
                    buttonContainer.style.height = '100%';
                    buttonContainer.style.width = '100%';
                    
                    buttonContainer.appendChild(input);
                    buttonContainer.appendChild(saveBtn);
                    buttonContainer.appendChild(cancelBtn);
                    
                    itemElement.appendChild(buttonContainer);
                    
                    // Focus the input and select all text
                    input.focus();
                    input.select();
                    
                    // Handle save
                    const saveHandler = () => {
                        const newName = input.value.trim();
                        if (newName !== '') {
                            if (typeof versionId === 'string' && versionId === 'current') {
                                // For current version, we don't actually rename it
                            } else {
                                historyRename(noteId, versionId, newName);
                            }
                        }
                        // Update the history list to show the new text
                        updateHistoryList();
                    };
                    
                    // Handle cancel
                    const cancelHandler = () => {
                        // Update the history list to show the original text
                        updateHistoryList();
                    };
                    
                    // Add event listeners
                    saveBtn.addEventListener('click', saveHandler);
                    cancelBtn.addEventListener('click', cancelHandler);
                    
                    // Handle Enter and Escape keys
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveHandler();
                        } else if (e.key === 'Escape') {
                            cancelHandler();
                        }
                    });
                    
                    // Handle blur (clicking outside)
                    input.addEventListener('blur', () => {
                        saveHandler();
                    });
                }
            });
            contextMenu.appendChild(renameItem);
            
            // Delete option - only show for versions, not current
            if (typeof versionId !== 'string' || versionId !== 'current') {
                const deleteItem = document.createElement('div');
                deleteItem.className = 'context-menu-item';
                deleteItem.textContent = 'Delete';
                deleteItem.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this version?')) {
                        historyDelete(noteId, versionId);
                    }
                    contextMenu.style.display = 'none';
                });
                contextMenu.appendChild(deleteItem);
            }
        }

        // Initialize the application when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>